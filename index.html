<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miruku Notes ☁️</title>
  <style>
    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background-color: #fffdf9;
      color: #333;
      padding: 2em;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 0.5em;
    }
    .note {
      background: #fff;
      border: 1px solid #ddd;
      padding: 1em;
      margin: 1em 0;
      border-radius: 12px;
    }
    textarea, input {
      width: 100%;
      padding: 0.5em;
      margin: 0.3em 0;
    }
    button {
      background-color: #f8c8dc;
      border: none;
      padding: 0.5em 1em;
      border-radius: 8px;
      cursor: pointer;
    }
    .dark {
      background-color: #333;
      color: #fff;
    }
  </style>
</head>
<body>
  <h1>Miruku 雲端筆記 ☁️</h1>
  <label>分類：<input type="text" id="categoryInput" placeholder="輸入分類"></label>
  <textarea id="noteInput" placeholder="輸入筆記內容..."></textarea>
  <button onclick="saveNote()">💾 儲存筆記</button>
  <div id="notes"></div>
  <button onclick="toggleTheme()">🌓 切換主題</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAxboGl9sxDdjAhitO6rLvAKbunZnqg09c",
      authDomain: "miruku-notes.firebaseapp.com",
      projectId: "miruku-notes",
      storageBucket: "miruku-notes.appspot.com",
      messagingSenderId: "533046171839",
      appId: "1:533046171839:web:23691d6df554310f2b8e0a",
      measurementId: "G-E3XZG8VLG6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let userId = "";

    firebase.auth().signInAnonymously().then(cred => {
      userId = cred.user.uid;
      loadNotes();
      loadTheme();
    });

    function saveNote() {
      const content = document.getElementById("noteInput").value;
      const category = document.getElementById("categoryInput").value;
      if (!content.trim()) {
        console.warn("❌ 無內容，筆記未儲存");
        return;
      }
      db.collection("notes").add({
        uid: userId,
        content,
        category,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        console.log("✅ 筆記已儲存至 Firestore");
        document.getElementById("noteInput").value = "";
        document.getElementById("categoryInput").value = "";
        loadNotes(); // 強制更新
      })
      .catch((error) => {
        console.error("⚠️ 儲存筆記失敗：", error);
      });
    }

    function loadNotes() {
      console.log("📥 正在載入筆記...");
      db.collection("notes").where("uid", "==", userId).orderBy("timestamp", "desc")
        .get()
        .then(snapshot => {
          const container = document.getElementById("notes");
          container.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log("📝 載入筆記：", data);
            const div = document.createElement("div");
            div.className = "note";
            div.innerHTML = `<strong>${data.category || '未分類'}</strong><br>${data.content}`;
            container.appendChild(div);
          });
        })
        .catch((error) => {
          console.error("⚠️ 載入筆記失敗：", error);
        });
    }

    function toggleTheme() {
      const theme = document.body.classList.toggle("dark") ? "dark" : "light";
      db.collection("users").doc(userId).set({ theme }, { merge: true });
    }

    function loadTheme() {
      db.collection("users").doc(userId).get().then(doc => {
        if (doc.exists && doc.data().theme === "dark") {
          document.body.classList.add("dark");
        }
      });
    }
  </script>
</body>
</html>
