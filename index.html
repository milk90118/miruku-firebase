<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miruku Notes â˜ï¸</title>
  <style>
    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background-color: #fffdf9;
      color: #333;
      padding: 2em;
      transition: background-color 0.3s, color 0.3s;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 0.5em;
      text-align: center;
    }
    .input-section {
      background: #fff;
      border: 1px solid #ddd;
      padding: 1.5em;
      margin: 1em 0;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .note {
      background: #fff;
      border: 1px solid #ddd;
      padding: 1em;
      margin: 1em 0;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .note:hover {
      transform: translateY(-2px);
    }
    .note-category {
      font-weight: bold;
      color: #f8c8dc;
      margin-bottom: 0.5em;
    }
    .note-content {
      line-height: 1.6;
    }
    .note-time {
      font-size: 0.8em;
      color: #666;
      margin-top: 0.5em;
    }
    textarea, input {
      width: 100%;
      padding: 0.5em;
      margin: 0.3em 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      resize: vertical;
      font-family: inherit;
    }
    textarea {
      min-height: 100px;
    }
    button {
      background-color: #f8c8dc;
      border: none;
      padding: 0.5em 1em;
      border-radius: 8px;
      cursor: pointer;
      margin: 0.2em;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #f5b7d1;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .controls {
      text-align: center;
      margin: 1em 0;
    }
    .status {
      padding: 0.5em;
      margin: 0.5em 0;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .dark {
      background-color: #333;
      color: #fff;
    }
    .dark .input-section,
    .dark .note {
      background-color: #444;
      border-color: #555;
      color: #fff;
    }
    .dark .note-time {
      color: #ccc;
    }
    .dark textarea,
    .dark input {
      background-color: #555;
      border-color: #666;
      color: #fff;
    }
    .dark button {
      background-color: #555;
      color: #fff;
    }
    .dark button:hover {
      background-color: #666;
    }
    .loading {
      text-align: center;
      padding: 2em;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Miruku é›²ç«¯ç­†è¨˜ â˜ï¸</h1>
  
  <div class="status" id="status"></div>
  
  <div class="input-section">
    <label>åˆ†é¡ï¼š<input type="text" id="categoryInput" placeholder="è¼¸å…¥åˆ†é¡ï¼ˆé¸å¡«ï¼‰"></label>
    <textarea id="noteInput" placeholder="è¼¸å…¥ç­†è¨˜å…§å®¹..."></textarea>
    <div class="controls">
      <button onclick="saveNote()" id="saveBtn">ğŸ’¾ å„²å­˜ç­†è¨˜</button>
      <button onclick="clearInputs()">ğŸ—‘ï¸ æ¸…ç©º</button>
      <button onclick="toggleTheme()">ğŸŒ“ åˆ‡æ›ä¸»é¡Œ</button>
    </div>
  </div>

  <div id="loading" class="loading">æ­£åœ¨è¼‰å…¥ç­†è¨˜...</div>
  <div id="notes"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyAxboGl9sxDdjAhitO6rLvAKbunZnqg09c",
      authDomain: "miruku-notes.firebaseapp.com",
      projectId: "miruku-notes",
      storageBucket: "miruku-notes.appspot.com",
      messagingSenderId: "533046171839",
      appId: "1:533046171839:web:23691d6df554310f2b8e0a",
      measurementId: "G-E3XZG8VLG6"
    };
    
    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let userId = "";
    let notesListener = null; // å„²å­˜ç›£è½å™¨å¼•ç”¨

    // ç‹€æ…‹é¡¯ç¤ºå‡½æ•¸
    function showStatus(message, type = 'success') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
      
      // 3ç§’å¾Œè‡ªå‹•éš±è—
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }

    // åŒ¿åç™»éŒ„ä¸¦åˆå§‹åŒ–
    firebase.auth().signInAnonymously()
      .then(cred => {
        userId = cred.user.uid;
        console.log('âœ… åŒ¿åç™»éŒ„æˆåŠŸï¼Œç”¨æˆ¶ID:', userId);
        loadTheme();
        setupRealtimeListener(); // è¨­ç½®å¯¦æ™‚ç›£è½å™¨
      })
      .catch(error => {
        console.error('âŒ ç™»éŒ„å¤±æ•—:', error);
        showStatus('ç™»éŒ„å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢', 'error');
      });

    // è¨­ç½®å¯¦æ™‚ç›£è½å™¨
    function setupRealtimeListener() {
      console.log('ğŸ“¡ è¨­ç½®å¯¦æ™‚ç›£è½å™¨...');
      
      // å¦‚æœå·²æœ‰ç›£è½å™¨ï¼Œå…ˆå–æ¶ˆ
      if (notesListener) {
        notesListener();
      }
      
      // è¨­ç½®æ–°çš„ç›£è½å™¨
      notesListener = db.collection("notes")
        .where("uid", "==", userId)
        .orderBy("timestamp", "desc")
        .onSnapshot(
          snapshot => {
            console.log('ğŸ“¥ æ”¶åˆ°å¯¦æ™‚æ›´æ–°ï¼Œç­†è¨˜æ•¸é‡:', snapshot.size);
            document.getElementById('loading').style.display = 'none';
            renderNotes(snapshot);
          },
          error => {
            console.error('âš ï¸ å¯¦æ™‚ç›£è½å¤±æ•—:', error);
            document.getElementById('loading').style.display = 'none';
            showStatus('è¼‰å…¥ç­†è¨˜å¤±æ•—', 'error');
          }
        );
    }

    // æ¸²æŸ“ç­†è¨˜
    function renderNotes(snapshot) {
      const container = document.getElementById("notes");
      container.innerHTML = "";
      
      if (snapshot.empty) {
        container.innerHTML = '<div class="loading">é‚„æ²’æœ‰ç­†è¨˜ï¼Œé–‹å§‹å¯«ä¸‹ä½ çš„ç¬¬ä¸€ç¯‡å§ï¼âœ¨</div>';
        return;
      }
      
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "note";
        
        // æ ¼å¼åŒ–æ™‚é–“
        let timeStr = '';
        if (data.timestamp) {
          const date = data.timestamp.toDate();
          timeStr = `<div class="note-time">${formatDate(date)}</div>`;
        }
        
        div.innerHTML = `
          <div class="note-category">${data.category || 'æœªåˆ†é¡'}</div>
          <div class="note-content">${escapeHtml(data.content)}</div>
          ${timeStr}
        `;
        
        container.appendChild(div);
      });
    }

    // å„²å­˜ç­†è¨˜
    function saveNote() {
      const content = document.getElementById("noteInput").value.trim();
      const category = document.getElementById("categoryInput").value.trim();
      
      if (!content) {
        showStatus('è«‹è¼¸å…¥ç­†è¨˜å…§å®¹', 'error');
        return;
      }
      
      // åœç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡æäº¤
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'â³ å„²å­˜ä¸­...';
      
      db.collection("notes").add({
        uid: userId,
        content: content,
        category: category,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        console.log("âœ… ç­†è¨˜å·²å„²å­˜è‡³ Firestore");
        showStatus('ç­†è¨˜å„²å­˜æˆåŠŸï¼', 'success');
        clearInputs();
      })
      .catch((error) => {
        console.error("âš ï¸ å„²å­˜ç­†è¨˜å¤±æ•—ï¼š", error);
        showStatus('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      })
      .finally(() => {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        saveBtn.disabled = false;
        saveBtn.textContent = 'ğŸ’¾ å„²å­˜ç­†è¨˜';
      });
    }

    // æ¸…ç©ºè¼¸å…¥æ¬„ä½
    function clearInputs() {
      document.getElementById("noteInput").value = "";
      document.getElementById("categoryInput").value = "";
    }

    // åˆ‡æ›ä¸»é¡Œ
    function toggleTheme() {
      const theme = document.body.classList.toggle("dark") ? "dark" : "light";
      
      // å„²å­˜ä¸»é¡Œè¨­å®šåˆ° Firestore
      if (userId) {
        db.collection("users").doc(userId).set({ theme }, { merge: true })
          .catch(error => console.error('ä¸»é¡Œå„²å­˜å¤±æ•—:', error));
      }
    }

    // è¼‰å…¥ä¸»é¡Œè¨­å®š
    function loadTheme() {
      if (!userId) return;
      
      db.collection("users").doc(userId).get()
        .then(doc => {
          if (doc.exists && doc.data().theme === "dark") {
            document.body.classList.add("dark");
          }
        })
        .catch(error => console.error('è¼‰å…¥ä¸»é¡Œå¤±æ•—:', error));
    }

    // å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'å‰›å‰›';
      if (minutes < 60) return `${minutes}åˆ†é˜å‰`;
      if (hours < 24) return `${hours}å°æ™‚å‰`;
      if (days < 7) return `${days}å¤©å‰`;
      
      return date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // å·¥å…·å‡½æ•¸ï¼šè½‰ç¾© HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }

    // éµç›¤å¿«æ·éµ
    document.addEventListener('keydown', function(e) {
      // Ctrl+Enter å„²å­˜ç­†è¨˜
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        saveNote();
      }
    });

    // é é¢é—œé–‰æ™‚æ¸…ç†ç›£è½å™¨
    window.addEventListener('beforeunload', function() {
      if (notesListener) {
        notesListener();
      }
    });
  </script>
</body>
</html>
